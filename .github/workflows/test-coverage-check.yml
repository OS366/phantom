name: Test Coverage Check

on:
  pull_request:
    branches:
      - main
    paths:
      - 'phantom.js'
      - 'phantom.test.js'

jobs:
  check-coverage:
    name: Verify Test Coverage for New Functions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for diff comparison
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci
      
      - name: Check test coverage for new functions
        working-directory: ./scripts
        run: |
          echo "üîç Checking for new functions and their test coverage..."
          # Fetch the base branch
          git fetch origin ${{ github.base_ref }}:${{ github.base_ref }} || true
          # Get the merge base
          BASE_SHA=$(git merge-base HEAD origin/${{ github.base_ref }} 2>/dev/null || echo "HEAD~1")
          echo "Comparing against base: $BASE_SHA"
          git diff $BASE_SHA -- phantom.js > /tmp/phantom.diff || echo "No changes in phantom.js"
          
          # Run coverage check in diff mode
          npm run test:check-diff || {
            echo "‚ö†Ô∏è Some new functions may be missing tests. Running full check..."
            npm run test:check
          }
      
      - name: Run existing tests
        working-directory: ./scripts
        run: npm test

